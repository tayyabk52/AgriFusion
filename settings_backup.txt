'use client';

import React, { useState, useEffect, useRef } from 'react';
import { useRouter } from 'next/navigation';
import { supabase } from '@/lib/supabaseClient';
import { FarmerDashboardLayout } from '@/components/dashboard/farmer/FarmerDashboardLayout';
import { useFarmerProfile } from '@/contexts/FarmerProfileContext';
import { Button } from '@/components/ui/Button';
import {
    User, Mail, Phone,
    Camera, Save, Lock, Shield, AlertCircle, CheckCircle2, X
} from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import Image from 'next/image';


interface Profile {
    id: string;
    auth_user_id: string;
    role: string;
    full_name: string;
    email: string;
    phone?: string;
    avatar_url?: string;
    status: string;
    is_verified: boolean;
}

interface FarmerData {
    id: string;
    profile_id: string;
    farm_name?: string;
    district?: string;
    state?: string;
    country?: string;
    land_size_acres?: number;
    current_crops?: string[];
}

export default function FarmerSettings() {
    const router = useRouter();
    const { profile, loading: profileLoading, refreshProfile } = useFarmerProfile();
    const [saving, setSaving] = useState(false);
    const [activeTab, setActiveTab] = useState<'profile' | 'security'>('profile');
    const [message, setMessage] = useState<{ type: 'success' | 'error', text: string } | null>(null);

    // Data States
    const [farmerData, setFarmerData] = useState<FarmerData | null>(null);

    // Form States
    const [formData, setFormData] = useState({
        full_name: '',
        phone: '',
    });

    const [avatarFile, setAvatarFile] = useState<File | null>(null);
    const [avatarPreview, setAvatarPreview] = useState<string | null>(null);
    const fileInputRef = useRef<HTMLInputElement>(null);

    useEffect(() => {
        if (profile) {
            initializeFormData();
        }
    }, [profile]);

    const initializeFormData = async () => {
        try {
            // Fetch Farmer Data
            const { data: farmer, error: farmerError } = await supabase
                .from('farmers')
                .select('*')
                .eq('profile_id', profile.id)
                .single();

            if (!farmerError) {
                setFarmerData(farmer);
            }

            // Initialize form
            setFormData({
                full_name: profile?.full_name || '',
                phone: profile?.phone || '',
            });

            if (profile?.avatar_url) {
                setAvatarPreview(profile.avatar_url);
            }
        } catch (error) {
            console.error('Error initializing data:', error);
        }
    };

    // Auto-dismiss message
    useEffect(() => {
        const handleInputChange = (e: React.ChangeEvent<HTMLInputElement | HTMLSelectElement>) => {
            const { name, value } = e.target;
            setFormData(prev => ({ ...prev, [name]: value }));
        };

        const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {
            const file = e.target.files?.[0];
            if (file) {
                if (file.size > 2 * 1024 * 1024) { // 2MB limit
                    setMessage({ type: 'error', text: 'Image size must be less than 2MB' });
                    return;
                }
                setAvatarFile(file);
                const reader = new FileReader();
                reader.onloadend = () => setAvatarPreview(reader.result as string);
                reader.readAsDataURL(file);
            }
        };



        const handleSaveProfile = async () => {
            if (!profile) return;
            setSaving(true);
            setMessage(null);

